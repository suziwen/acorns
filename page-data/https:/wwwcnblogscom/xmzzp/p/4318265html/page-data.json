{"componentChunkName":"component---node-modules-suziwen-gatsby-theme-sculpting-src-templates-template-blog-post-js","path":"/https:/wwwcnblogscom/xmzzp/p/4318265html","result":{"data":{"zipFile":{"publicURL":"/acorns/static/93d128fb1c05b77c3bf8c0d6909c28af/编写CodeMirror Modes详解.zip"},"site":{"siteMetadata":{"siteUrl":"https://suziwen.github.io/acorns"}},"storyWriterMarkdown":{"id":"37034980-0a96-505d-bf0c-e896a0c49123","html":"\n\n\t<div class=\"preview html_preview xsj_export_zip\"><div style=\"overflow: hidden; position: absolute; top: 0; height: 1px; width: auto; padding: 0; border: 0; margin: 0; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;\"><svg><defs id=\"MathJax_SVG_glyphs\"/><defs xmlns=\"http://www.w3.org/2000/svg\"><filter xmlns=\"http://www.w3.org/2000/svg\" id=\"dropshadow\" height=\"130%\">      <fegaussianblur in=\"SourceAlpha\" stddeviation=\"3\"/>       <feoffset dx=\"2\" dy=\"2\" result=\"offsetblur\"/>       <femerge>         <femergenode/>        <femergenode in=\"SourceGraphic\"/>       </femerge>    </filter><filter id=\"editing-stripe-bk\" filterunits=\"userSpaceOnUse\" x=\"-100%\" y=\"-100%\" width=\"300%\" height=\"300%\"><feflood flood-color=\"#700f0f\" result=\"flood1\"/><feflood flood-color=\"#fff\" flood-opacity=\"0.5\" result=\"flood2\"/><feimage xlink:href=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAwcHgiIGhlaWdodD0iMTAwMHB4Ij48ZGVmcz48cGF0dGVybiBpZD0icGF0dGVybiIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeD0iMCIgeT0iMCIgd2lkdGg9IjQiIGhlaWdodD0iNCI+PHBhdGggZD0iTSAtNCAtNCBMIDggOCBNIC04IC00IEwgNCA4IE0gLTQgLTggTCA4IDQiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIxIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI3BhdHRlcm4pIi8+PC9zdmc+\" x=\"0\" y=\"0\" width=\"2000\" height=\"1000\" result=\"image\"/><fetile in=\"image\" result=\"tile\"/><fecomposite operator=\"in\" in=\"flood1\" in2=\"tile\" result=\"tile2\"/><fegaussianblur in=\"SourceAlpha\" stddeviation=\"10\" result=\"blur\"/><fecomposite operator=\"in\" in=\"tile2\" in2=\"blur\" result=\"cloud\"/><femorphology operator=\"dilate\" radius=\"2\" in=\"SourceAlpha\" result=\"dilate\"/><fecomposite operator=\"in\" in=\"flood2\" in2=\"dilate\" result=\"base\"/><femerge><femergenode in=\"cloud\"/><femergenode in=\"base\"/><femergenode in=\"SourceGraphic\"/></femerge></filter></defs></svg></div><blockquote class=\"markdown_blockquote\">\n<p class=\"xsj_paragraph xsj_paragraph_level_1\"><span class=\"xsj_placeholder_span\"></span>本文为转载文章, 仅用于自己的知识管理收集, 如果涉及侵权,请联系 <a href=\"mailto:suziwen1@gmail.com\" class=\"xsj_link xsj_auto_link\">suziwen1@gmail.com</a>,会第一时间删除<br>\n收集该文章,并非代表本人支持文中观点,只是觉得文章内容容易引起思考,讨论,有它自有的价值</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_1\"><span class=\"xsj_placeholder_span\"></span>转载自: <a href=\"https://www.cnblogs.com/xmzzp/p/4318265.html\" class=\"xsj_link xsj_auto_link\">https://www.cnblogs.com/xmzzp/p/4318265.html</a></p>\n</blockquote>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\"></p><div class=\"toc mindmap_toc mindmap_container\" data-vdom-skip=\"true\" data-hash=\"b1332e3ca93dadfe1cf74a591b675e07_mindmap_toc\"><div class=\"xsj_mindmap xsj_mindmap_toc\"><svg id=\"xsj_mindmap_toc_1627621767462\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" class=\"xsj_svg_viewbox\" style=\"max-width:921px;max-height:512px;\" viewbox=\"0 0 921 512\" width=\"100%\" height=\"100%\"><g transform=\"translate(368.5,278) scale(1)\"><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#3366cc\" stroke-width=\"1\" d=\"M342.5,-37 L347.5,-37 C383.5,-37 378.5,148 414.5,148 L416.5,148\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(342.5, -37)\" points=\"0,-1 5,0 0,1 -5,0\" style=\"fill: white;\"/><g transform=\"translate(414.5,148)\"><path class=\"markmap-node-path\" d=\"M0,0L44,0\" stroke-width=\"1\" stroke=\"#3366cc\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(44, 0)\" points=\"0,-0.5 5,0 0,0.5 -5,0\" style=\"fill: rgb(51, 102, 204);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#3366cc\" stroke-width=\"1\" d=\"M342.5,-37 L347.5,-37 C383.5,-37 378.5,74 414.5,74 L416.5,74\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(342.5, -37)\" points=\"0,-1 5,0 0,1 -5,0\" style=\"fill: white;\"/><g transform=\"translate(414.5,74)\"><path class=\"markmap-node-path\" d=\"M0,0L89,0\" stroke-width=\"1\" stroke=\"#3366cc\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(89, 0)\" points=\"0,-0.5 5,0 0,0.5 -5,0\" style=\"fill: rgb(51, 102, 204);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#3366cc\" stroke-width=\"1\" d=\"M342.5,-37 L347.5,-37 C383.5,-37 378.5,0 414.5,0 L416.5,0\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(342.5, -37)\" points=\"0,-1 5,0 0,1 -5,0\" style=\"fill: white;\"/><g transform=\"translate(414.5,0)\"><path class=\"markmap-node-path\" d=\"M0,0L59,0\" stroke-width=\"1\" stroke=\"#3366cc\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(59, 0)\" points=\"0,-0.5 5,0 0,0.5 -5,0\" style=\"fill: rgb(51, 102, 204);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#3366cc\" stroke-width=\"1\" d=\"M342.5,-37 L347.5,-37 C383.5,-37 378.5,-74 414.5,-74 L416.5,-74\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(342.5, -37)\" points=\"0,-1 5,0 0,1 -5,0\" style=\"fill: white;\"/><g transform=\"translate(414.5,-74)\"><path class=\"markmap-node-path\" d=\"M0,0L74,0\" stroke-width=\"1\" stroke=\"#3366cc\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(74, 0)\" points=\"0,-0.5 5,0 0,0.5 -5,0\" style=\"fill: rgb(51, 102, 204);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#3366cc\" stroke-width=\"1\" d=\"M342.5,-37 L347.5,-37 C383.5,-37 378.5,-148 414.5,-148 L416.5,-148\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(342.5, -37)\" points=\"0,-1 5,0 0,1 -5,0\" style=\"fill: white;\"/><g transform=\"translate(414.5,-148)\"><path class=\"markmap-node-path\" d=\"M0,0L74,0\" stroke-width=\"1\" stroke=\"#3366cc\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(74, 0)\" points=\"0,-0.5 5,0 0,0.5 -5,0\" style=\"fill: rgb(51, 102, 204);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#3366cc\" stroke-width=\"1\" d=\"M342.5,-37 L347.5,-37 C383.5,-37 378.5,-222 414.5,-222 L416.5,-222\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(342.5, -37)\" points=\"0,-1 5,0 0,1 -5,0\" style=\"fill: white;\"/><g transform=\"translate(414.5,-222)\"><path class=\"markmap-node-path\" d=\"M0,0L74,0\" stroke-width=\"1\" stroke=\"#3366cc\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(74, 0)\" points=\"0,-0.5 5,0 0,0.5 -5,0\" style=\"fill: rgb(51, 102, 204);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#3366cc\" stroke-width=\"2\" d=\"M255.5,-39 L260.5,-39 C296.5,-39 291.5,-37 327.5,-37 L329.5,-37\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(255.5, -39)\" points=\"0,-2 5,0 0,2 -5,0\" style=\"fill: white;\"/><g transform=\"translate(327.5,-37)\"><path class=\"markmap-node-path\" d=\"M0,0L14,0\" stroke-width=\"2\" stroke=\"#3366cc\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(14, 0)\" points=\"0,-1 5,0 0,1 -5,0\" style=\"fill: rgb(51, 102, 204);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#3366cc\" stroke-width=\"4\" d=\"M132.5,-39 L137.5,-39 C209.5,-39 204.5,-39 240.5,-39 L242.5,-39\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(132.5, -39)\" points=\"0,-3 5,0 0,3 -5,0\" style=\"fill: white;\"/><g transform=\"translate(240.5,-39)\"><path class=\"markmap-node-path\" d=\"M0,0L14,0\" stroke-width=\"4\" stroke=\"#3366cc\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(14, 0)\" points=\"0,-2 5,0 0,2 -5,0\" style=\"fill: rgb(51, 102, 204);\"/></g></g><g class=\"markmap-node markmap-root-node\" transform=\"translate(-276.5,-39)\"><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(408, 0)\" points=\"0,-3 5,0 0,3 -5,0\" style=\"fill: rgb(51, 102, 204);\"/><g transform=\"translate(1, -34)\"><rect class=\"markmap-node-rect\" rx=\"10\" ry=\"10\" height=\"68\" width=\"407\" fill=\"rgb(78, 156, 255)\" stroke=\"#3366cc\" stroke-width=\"1\"/><text class=\"markmap-node-text\" alignment-baseline=\"middle\" x=\"204.5\" y=\"38\" text-anchor=\"middle\" style=\"font: bolder 30px sans-serif; fill-opacity: 1; fill: rgb(255, 255, 255);\">编写CodeMirror Modes详解</text></g></g><g class=\"markmap-node\" transform=\"translate(240.5,-39)\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(51, 102, 204); stroke: white; stroke-width: 2px;\"/><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(51, 102, 204);\"/></g><g class=\"markmap-node\" transform=\"translate(327.5,-37)\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204); stroke: white; stroke-width: 2px;\"/><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204);\"/></g><g class=\"markmap-node\" transform=\"translate(414.5,148)\"><a xlink:href=\"#e6a0b7e5bc8fe58c96_6\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204); stroke: white; stroke-width: 2px; cursor: pointer;\">样式化</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204); cursor: pointer;\">样式化</text></a></g><g class=\"markmap-node\" transform=\"translate(414.5,74)\"><a xlink:href=\"#e8af8de6b395e58886e69e90e587bde695b0_5\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204); stroke: white; stroke-width: 2px; cursor: pointer;\">词法分析函数</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204); cursor: pointer;\">词法分析函数</text></a></g><g class=\"markmap-node\" transform=\"translate(414.5,0)\"><a xlink:href=\"#e78ab6e68081e5afb9e8b1a1_4\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204); stroke: white; stroke-width: 2px; cursor: pointer;\">状态对象</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204); cursor: pointer;\">状态对象</text></a></g><g class=\"markmap-node\" transform=\"translate(414.5,-74)\"><a xlink:href=\"#e4bba3e7a081e7baa6e69d9fefbc9a_3\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204); stroke: white; stroke-width: 2px; cursor: pointer;\">代码约束：</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204); cursor: pointer;\">代码约束：</text></a></g><g class=\"markmap-node\" transform=\"translate(414.5,-148)\"><a xlink:href=\"#e6b3a8e5868ce6a8a1e5bc8fefbc9a_2\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204); stroke: white; stroke-width: 2px; cursor: pointer;\">注册模式：</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204); cursor: pointer;\">注册模式：</text></a></g><g class=\"markmap-node\" transform=\"translate(414.5,-222)\"><a xlink:href=\"#e5a4a7e887b4e58e9fe79086efbc9a_1\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204); stroke: white; stroke-width: 2px; cursor: pointer;\">大致原理：</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(51, 102, 204); cursor: pointer;\">大致原理：</text></a></g><g class=\"annotation-group\"><g class=\"annotations\"/></g></g></svg></div></div><p></p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">在写新的模式(mode)之前，还是先来概括一下CodeMirror的设计思路。CodeMirror分为三部分：<strong class=\"markdown_strong_asterisk\">核心，模式，扩展</strong>。核心库对外开放了很多接口，而这些接口就是实现新模式或者新扩展的基石。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">在使用CodeMirror的过程中，如果我们需要的mode不在CodeMirror自带的Modes里面，就需要我们自定义mode，比如ini文件类型，CodeMirror自身并没有实现，这时候就需要设计新的mode。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">顺便提一下mode和language的区别，mode和language并不是完全一一对应，比如html代码中，往往包含javascript 和css代码，对于混杂着javascript和css代码的html文档，我们抽象成一个htmlmixed模式，就是所谓的“多重模式”，而 javascript和css也有自身对于的mode。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">多重模式的实现对单一模式是有依赖的，这也体现了CodeMirror作者良好了设计功底，代码尽量得到最大效率的利用，htmlmixed模式内部就是\"javascript\",\"css\",\"xml\"三种模式的轮询。</p>\n<h4 class=\"xsj_heading_hash xsj_heading xsj_heading_h4\" id=\"e5a4a7e887b4e58e9fe79086efbc9a_1\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"e5a4a7e887b4e58e9fe79086efbc9a_1\" class=\"blank_anchor_name\"></a><a id=\"e5a4a7e887b4e58e9fe79086efbc9a_1\" class=\"blank_anchor_id\"></a><a name=\"大致原理\" class=\"blank_anchor_name\"></a><a id=\"大致原理\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">大致原理：</span></h4>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">拿典型的javascript文件来说，要完成javascript模式，只要定义一个词法分析程序就可以，首先，CodeMirror核心程序已经将整个javascript文档按照行做了拆分，你在mode里所需要做的就是写一个词法分析程序分析每一行数据。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">对于单行的字符串文本，词法分析程序需要从字符串开始分析到字符串结束，在这过程中，会对需要标识的字符或者字符串(比如[ ] {} (),this,function等)做特殊标识，并且返回一个css样式(用于高亮)给对应被标识的字符或者字符串，这就是大概的处理过程。更高级的用 法还可以控制代码文档的缩进等。</p>\n<h4 class=\"xsj_heading_hash xsj_heading xsj_heading_h4\" id=\"e6b3a8e5868ce6a8a1e5bc8fefbc9a_2\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"e6b3a8e5868ce6a8a1e5bc8fefbc9a_2\" class=\"blank_anchor_name\"></a><a id=\"e6b3a8e5868ce6a8a1e5bc8fefbc9a_2\" class=\"blank_anchor_id\"></a><a name=\"注册模式\" class=\"blank_anchor_name\"></a><a id=\"注册模式\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">注册模式：</span></h4>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">在模式的实现脚本中，首先要调用CodeMirror.defineMode接口注册模式，这个接口函数包含两个参数：</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">第一个参数类型为字符串，是模式的名称，一律使用小写，一般情况下，注册的模式名称保持跟模式脚本名称一样，比如xml模式的实现脚本为\"xml.js\"，注册的模式名就使用\"xml\"。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">第二个参数类型为函数，该函数也有两个入参：分别是CodeMirror的配置对象(传递给CodeMirror构造函数使用，参见配置一节)和mode的配置对象(包含哪些属性由具体的mode决定)。该函数的返回值是mode对象，具体内容后面会提到。</p>\n<h4 class=\"xsj_heading_hash xsj_heading xsj_heading_h4\" id=\"e4bba3e7a081e7baa6e69d9fefbc9a_3\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"e4bba3e7a081e7baa6e69d9fefbc9a_3\" class=\"blank_anchor_name\"></a><a id=\"e4bba3e7a081e7baa6e69d9fefbc9a_3\" class=\"blank_anchor_id\"></a><a name=\"代码约束\" class=\"blank_anchor_name\"></a><a id=\"代码约束\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">代码约束：</span></h4>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">在编写Mode代码的时候，所有代码都要控制在与调用CodeMirror.defineMode接口的同一作用域内，所有函数变量的申明都要写在CodeMirror.defineMode第二个参数(函数)内部。这样可以避免mode变量对全局变量造成污染。</p>\n<h4 class=\"xsj_heading_hash xsj_heading xsj_heading_h4\" id=\"e78ab6e68081e5afb9e8b1a1_4\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"e78ab6e68081e5afb9e8b1a1_4\" class=\"blank_anchor_name\"></a><a id=\"e78ab6e68081e5afb9e8b1a1_4\" class=\"blank_anchor_id\"></a><a name=\"状态对象\" class=\"blank_anchor_name\"></a><a id=\"状态对象\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">状态对象</span></h4>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">Mode的主要作用就是对行文本进行词法分析进而进行文本标识(高亮)，当然了主要功能也是基础功能，大部分mode的设计要求远远不止对文本进行高亮，同时，某种语言的复杂程度也影响着mode的复杂程度。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">有些规则很简洁明确的语言，可能每行的词法分析都是跟上一行没有关系的，比如ini文件，它的注释，块，键值肯定在同一行内，不可能跨行，词法分析函数关起门来潜心练就九阴真经就行了。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">不幸的是，大多数语言的规则都是比较复杂的，就拿javascript来讲，一个数组可以在行内写，也可以跨行写，如果跨行写的话，那么后一行的词法分析肯定就会对前一行的文本有依赖，要不然无法进行正确的分析。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">鉴于这个原因，CodeMirror设计了状态对象(state Object)，该对象是唯一的，也可以认为是每一行共享的(类似全局变量)，它的属性在词法分析函数内部做维护，如此一来不同行之前就有了联系，词法分 析函数在分析当前行文本的时候，可以从状态对象获取到自己感兴趣的信息。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">在需要使用状态对象的Modes内部，mode对象必须定义一个startState属性，该属性是一个函数，函数返回一个对象，这个对象便是状态 对象，在开始对整个文档进行分析之前，CodeMirror就会利用startState生成一个状态对象，而这个状态对象里面有哪些属性，完全是根据 mode的设计要求和思路来决定的。</p>\n<h4 class=\"xsj_heading_hash xsj_heading xsj_heading_h4\" id=\"e8af8de6b395e58886e69e90e587bde695b0_5\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"e8af8de6b395e58886e69e90e587bde695b0_5\" class=\"blank_anchor_name\"></a><a id=\"e8af8de6b395e58886e69e90e587bde695b0_5\" class=\"blank_anchor_id\"></a><a name=\"词法分析函数\" class=\"blank_anchor_name\"></a><a id=\"词法分析函数\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">词法分析函数</span></h4>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">在mode的设计中，mode对象的词法分析函数(token(stream,state))是最重要的,所有的mode都要定义这个方法。<br>\n首先token函数有两个入参：</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">stream：CodeMirror核心内部定义的Stream类的实例，它不光包含当前行的文本信息，还包含已经分析到的字符位置(字符串分析的时候，是一个个字符顺序分析的)，也包含一系列使用的字符串处理方法；</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">state：就是状态对象，每次词法分析，都会传入这个参数，然后在词法分析内部维护这个参数的属性。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">在分析同一行文本的时候，token函数会被反复调用，只要是遇到一个需要标识的子字符串片段或者空白字符，token都会return，直到分析到整行结尾，看个例子，有以下一行javascript代码：</p>\n<div class=\"xiaoshujiang_code_container\"><div data-processed=\"true\" class=\"xiaoshujiang_pre\"><div class=\"language-javascript hljs code_linenums xiaoshujiang_code\"><ol start=\"1\" class=\"ol_linenums\" style=\"counter-reset: lines 0;\"><li class=\"li_linenum \" date-linenum=\"1\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">1</span><span class=\"hljs-keyword\">var</span> name = <span class=\"hljs-keyword\">this</span>.name;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li></ol></div></div></div>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">一、 token从字符串第一个字符开始分析，此时stream.pos为0，遇到一个关键字\"var\"，则返回一个css样式\"keyword\",同时 stream.pos移动到2，CodeMirror将会给var外面加上span标签，该标签的class就是\"cm-kerword\"（被核心模块加 上了\"cm-\"前缀，token函数返回的所有样式都会被加上这个前缀），cm-kerword样式定义在codemirror.css文件中。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">二、 字符串还没有到结束，第二次调用token分析，遇到一个空格，返回null，也就是说空格不需要高亮，同时stream.pos移动到3；</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">三、字符串还没有到结束，第三次调用token分析，遇到一个属性name，返回\"properties\",同时stream.pos移动到7,CodeMirror将会给name外面加上span标签，该标签的class是\"cm-properties\"。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">四、字符串还没有到结束，继续调用token，直到分析完这个字符串才会结束。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">其实词法分析的概要过程就是这样的，是不是很简单呢？具体实现的细节其实还是比较繁琐的。</p>\n<h4 class=\"xsj_heading_hash xsj_heading xsj_heading_h4\" id=\"e6a0b7e5bc8fe58c96_6\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"e6a0b7e5bc8fe58c96_6\" class=\"blank_anchor_name\"></a><a id=\"e6a0b7e5bc8fe58c96_6\" class=\"blank_anchor_id\"></a><a name=\"样式化\" class=\"blank_anchor_name\"></a><a id=\"样式化\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">样式化</span></h4>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">样式化是在词法分析过程中完成的，也是词法分析的目的，CodeMirror支持好几种样式化的方式，都是通过特殊关键字来区别的</p>\n<ol class=\"markdown_ol\">\n<li>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>普通样式，不包含\"line-\"和\"line-background-\"前缀的都是普通样式，作用在整行字符串的某个词汇或子字符串上。</p>\n</li>\n<li>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>带有\"line-\"前缀的样式，作用在整行文字上，在DOM结构里，该样式是加在pre标签上的。需要注意的是在整行字符串分析的过程过，只要有一次返回值包含\"line-\"前缀，pre标签就会被加上对应样式，多次返回不同值，则会增加多个样式。</p>\n</li>\n<li>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>带有\"line-background-\"前缀的样式作用整行文字的背景，该样式会创建一个跟pre平行的块元素，其z-index小于pre标 签，pre自身的背景被设置为透明，所以新创建的块元素模拟了整行文本的背景色。跟\"line-\"前缀一样，多次返回便是增加多个样式</p>\n</li>\n<li>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>token还可以返回多重样式（使用空格做分割），例如返回\"string error\"，则是字符串样式（着色）和Error（划线）样式的叠加。</p>\n</li>\n</ol>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\"><strong class=\"markdown_strong_asterisk\">PS:codemirror.css文件没有的样式都需要自行定义，一般自定义的样式文件写在跟mode脚本文件同目录同名。</strong></p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">看个被标识好的整行DOM结构或许会更清楚：</p>\n<div class=\"xiaoshujiang_code_container\"><div data-processed=\"true\" class=\"xiaoshujiang_pre\"><div class=\"language-html hljs xml code_linenums xiaoshujiang_code\"><ol start=\"1\" class=\"ol_linenums\" style=\"counter-reset: lines 0;\"><li class=\"li_linenum \" date-linenum=\"1\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">1</span><span class=\"hljs-comment\">&lt;!-- 整个一行的DOM结构 --&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"2\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">2</span><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"\"</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"position: relative;\"</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"3\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">3</span>    <span class=\"hljs-comment\">&lt;!-- 只有token函数返回带有line-background-关键字的样式，这个节点才会被创建 --&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"4\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">4</span>    <span class=\"hljs-comment\">&lt;!-- 本示例token返回值包含line-background-linebgc --&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"5\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">5</span>    <span class=\"hljs-comment\">&lt;!-- CodeMirror-linebackground样式定义在codemirror.css中,linebgc则需要自己定义--&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum line_mark\" date-linenum=\"6\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">6</span>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"linebgc  CodeMirror-linebackground\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"7\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">7</span>    <span class=\"hljs-comment\">&lt;!-- 行号对应的DOM 不在token的作用范围内 --&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"8\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">8</span>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"CodeMirror-gutter-wrapper\"</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"position: absolute; left: -29px;\"</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"9\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">9</span>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"CodeMirror-linenumber CodeMirror-gutter-elt\"</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"left: 0px; width: 20px;\"</span>&gt;</span>3<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"10\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">10</span>    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"11\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">11</span>    <span class=\"hljs-comment\">&lt;!-- 正式的整行文本对应的DOM,该标签的背景被CodeMirror设置为透明 --&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"12\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">12</span>    <span class=\"hljs-comment\">&lt;!-- pre标签被增加了\"linetext\"样式，是因为token返回值中包含了\"line-linetext\",有\"line-\"前缀，所以生成了这个样式 --&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"13\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">13</span>    <span class=\"hljs-comment\">&lt;!-- linetext 样式需要自行定义 --&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum line_mark\" date-linenum=\"14\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">14</span>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">pre</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"linetext \"</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"15\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">15</span>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">span</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"padding-right: 0.1px;\"</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"16\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">16</span>            <span class=\"hljs-comment\">&lt;!-- token返回值包含key --&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum line_mark\" date-linenum=\"17\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">17</span>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">span</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"cm-key\"</span>&gt;</span>innodb_log_file_size<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"18\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">18</span>            <span class=\"hljs-comment\">&lt;!-- token返回值包含\"equal-symbol strong\" 是一个多重样式 --&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum line_mark\" date-linenum=\"19\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">19</span>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">span</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"cm-equal-symbol cm-strong\"</span>&gt;</span>=<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"20\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">20</span>            <span class=\"hljs-comment\">&lt;!-- token返回值包含\"vaule\" --&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum line_mark\" date-linenum=\"21\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">21</span>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">span</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"cm-value\"</span>&gt;</span>10M<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"22\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">22</span>            <span class=\"hljs-comment\">&lt;!-- token返回值包含\"comment\" --&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum line_mark\" date-linenum=\"23\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">23</span>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">span</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"cm-comment\"</span>&gt;</span>;ddad<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"24\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">24</span>        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"25\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">25</span>    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">pre</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"26\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">26</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li></ol></div></div></div>\n</div>\n\n","excerpt":"在写新的模式(mode)之前，还是先来概括一下CodeMirror的设计思路。CodeMirror分为三部分：核心，模式，扩展。核心库对外开放了很多接口，而这些接口就是实现新模式或者新扩展的基石。\n在使用CodeMirror的过程中，如果我们需要的mode不在CodeMirror...","docType":"posts","slug":"https:/wwwcnblogscom/xmzzp/p/4318265html","title":"编写CodeMirror Modes详解","customCss":"","createDate":"February 01, 2021","updateDate":"February 03, 2021","tags":["文章","转载","技术"]}},"pageContext":{"slug":"https:/wwwcnblogscom/xmzzp/p/4318265html","zipPath":"/home/runner/work/acorns/acorns/posts/web/编写CodeMirror Modes详解.zip","prev":{"title":"CodeMirror 内部代码的研究","docType":"posts","slug":"study/inspect-codemirror-source"},"next":{"title":"Exploring the Complexities of Width and Height in CSS","docType":"posts","slug":"web/Exploring the Complexities of Width and Height in CSS"},"pluginOptions":{"tagsPath":"/tags/","archivesPath":"/archives/","basePath":"/","commentType":"gitalk"},"basePath":"/"}},"staticQueryHashes":["2682448919","2682448919"]}